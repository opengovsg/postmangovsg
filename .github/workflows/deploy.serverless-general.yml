name: Deploy serverless using serverless.yml

on:
  push:
    branches:
      - staging
      - master

# Making sure that the current deployment is completed before the next one
concurrency: deploy-serverless-general-${{ github.ref }}

permissions:
  id-token: write
  contents: read

jobs:
  set_environment:
    outputs:
      current_env: "${{ steps.set-environment.outputs.current_env }}"
    runs-on: ubuntu-latest
    steps:
      - id: set-environment
        run: |
          echo "Running on branch ${{ github.ref }}"
          if [ "${{ github.ref }}" = "refs/heads/master" ]; then
            echo "::set-output name=current_env::production"
          else
            echo "::set-output name=current_env::staging"
          fi
  serverless-deploy:
    needs: [set_environment]
    name: deploy serverless using serverless.yml
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source code
        uses: actions/checkout@v2

      - uses: actions/setup-node@v3
        with:
          node-version-file: ".nvmrc"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: "${{ secrets.AWS_ACCESS_KEY_ID }}"
          aws-secret-access-key: "${{ secrets.AWS_SECRET_ACCESS_KEY }}"
          aws-region: "${{ secrets.AWS_DEFAULT_REGION }}"

      - name: Install node dependencies
        working-directory: ./serverless
        run: npm ci

      - name: Deploy with Serverless Framework
        working-directory: ./serverless
        env:
          ENV: ${{ needs.set_environment.outputs.current_env }}
        run: npm run deploy
