language: node_js
node_js:
  - lts/*

services:
  - docker
  - postgresql

# Deploy from Dockerfile
jobs:
  include:
  - name: backend
    before_script:
      - cd backend
      - psql -c 'create database postmangovsgtest;' -U postgres
    script:
      - npm install
      - npm run test

    deploy:
      - provider: elasticbeanstalk
        skip_cleanup: true
        access_key_id: $AWS_ACCESS_KEY_ID_FOR_DEPLOYMENT
        secret_access_key: $AWS_SECRET_ACCESS_KEY_FOR_DEPLOYMENT
        region: "ap-northeast-1"
        app: "postmangovsg-backend"
        env: "postmangovsg-backend-staging"
        bucket_name: "postmangovsg-backend-elasticbeanstalk"
        on:
          branch: $STAGING_BRANCH
      - provider: elasticbeanstalk
        skip_cleanup: true
        access_key_id: $AWS_ACCESS_KEY_ID_FOR_DEPLOYMENT
        secret_access_key: $AWS_SECRET_ACCESS_KEY_FOR_DEPLOYMENT
        region: "ap-northeast-1"
        app: "postmangovsg-backend"
        env: "postmangovsg-backend-prod"
        bucket_name: "postmangovsg-backend-elasticbeanstalk"
        on:
          branch: $PRODUCTION_BRANCH
